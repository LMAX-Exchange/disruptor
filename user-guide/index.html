<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>LMAX Disruptor User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>LMAX Disruptor User Guide</h1>
<div class="details">
<span id="revnumber">version 4.0.0-SNAPSHOT</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_using_the_disruptor">Using the Disruptor</a>
<ul class="sectlevel2">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_getting_started">Getting Started</a></li>
<li><a href="#_advanced_techniques">Advanced Techniques</a></li>
</ul>
</li>
<li><a href="#_design_and_implementation">Design and Implementation</a></li>
<li><a href="#_known_issues">Known Issues</a></li>
<li><a href="#_batch_rewind">Batch Rewind</a>
<ul class="sectlevel2">
<li><a href="#_the_feature">The Feature</a></li>
<li><a href="#_use_case">Use Case</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The LMAX Disruptor is a high performance inter-thread messaging library. It grew out of LMAX&#8217;s research into concurrency, performance and non-blocking algorithms and today forms a core part of their Exchange&#8217;s infrastructure.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_disruptor">Using the Disruptor</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>The Disruptor is a library that provides a concurrent ring buffer data structure.
It is designed to provide a low-latency, high-throughput work queue in asynchronous event processing architectures.</p>
</div>
<div class="paragraph">
<p>To understand the benefits of the Disruptor we can compare it to something well understood and quite similar in purpose.
In the case of the Disruptor this would be Java&#8217;s <code>BlockingQueue</code>.
Like a queue the purpose of the Disruptor is to move data (e.g. messages or events) between threads within the same process.
However, there are some key features that the Disruptor provides that distinguish it from a queue.
They are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multicast events to consumers, with <a href="#_consumer_dependency_graph">consumer dependency graph</a>.</p>
</li>
<li>
<p><a href="#_event_pre_allocation">Pre-allocate memory</a> for events.</p>
</li>
<li>
<p><a href="#_optionally_lock_free">Optionally lock-free</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_core_concepts">Core Concepts</h4>
<div class="paragraph">
<p>Before we can understand how the Disruptor works, it is worthwhile defining a number of terms that will be used throughout the documentation and the code.
For those with a DDD bent, think of this as the ubiquitous language of the Disruptor domain.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ring Buffer</strong>: The Ring Buffer is often considered the main aspect of the Disruptor.
However, from 3.0 onwards, the Ring Buffer is only responsible for the storing and updating of the data (<code>Event</code>s) that move through the Disruptor.
For some advanced use cases, it can even be completely replaced by the user.</p>
</li>
<li>
<p><strong>Sequence</strong>: The Disruptor uses <code>Sequence</code>s as a means to identify where a particular component is up to.
Each consumer (Event Processor) maintains a <code>Sequence</code> as does the Disruptor itself.
The majority of the concurrent code relies on the movement of these Sequence values, hence the <code>Sequence</code> supports many of the current features of an <code>AtomicLong</code>.
In fact the only real difference between the two is that the <code>Sequence</code> contains additional functionality to prevent false sharing between <code>Sequence</code>s and other values.</p>
</li>
<li>
<p><strong>Sequencer</strong>: The Sequencer is the real core of the Disruptor.
The two implementations (single producer, multi producer) of this interface implement all the concurrent algorithms for fast, correct passing of data between producers and consumers.</p>
</li>
<li>
<p><strong>Sequence Barrier</strong>: The Sequencer produces a Sequence Barrier that contains references to the main published <code>Sequence</code> from the Sequencer and the <code>Sequence</code>s of any dependent consumer.
It contains the logic to determine if there are any events available for the consumer to process.</p>
</li>
<li>
<p><strong>Wait Strategy</strong>: The Wait Strategy determines how a consumer will wait for events to be placed into the Disruptor by a producer.
More details are available in the section about being optionally lock-free.</p>
</li>
<li>
<p><strong><code>Event</code></strong>: The unit of data passed from producer to consumer.
There is no specific code representation of the Event as it defined entirely by the user.</p>
</li>
<li>
<p><strong>Event Processor</strong>: The main event loop for handling events from the Disruptor and has ownership of consumer&#8217;s Sequence.
There is a single representation called BatchEventProcessor that contains an efficient implementation of the event loop and will call back onto a used supplied implementation of the EventHandler interface.</p>
</li>
<li>
<p><strong>Event Handler</strong>: An interface that is implemented by the user and represents a consumer for the Disruptor.</p>
</li>
<li>
<p><strong>Producer</strong>: This is the user code that calls the Disruptor to enqueue <code>Event</code>s.
This concept also has no representation in the code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To put these elements into context, below is an example of how LMAX uses the Disruptor within its high performance core services, e.g. the exchange.</p>
</div>
<div id="user-guide-models" class="imageblock">
<div class="content">
<img src="./../resources/images/user-guide/models.png" alt="models">
</div>
<div class="title">Figure 1. Disruptor with a set of dependent consumers.</div>
</div>
</div>
<div class="sect3">
<h4 id="_multicast_events">Multicast Events</h4>
<div class="paragraph">
<p>This is the biggest behavioural difference between queues and the Disruptor.</p>
</div>
<div class="paragraph">
<p>When you have multiple consumers listening on the same Disruptor, it publishes all events to all consumers.
In contrast, a queue will only send a single event to a single consumer.
You can use this behaviour of the Disruptor when you need to independent multiple parallel operations on the same data.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Example use-case</div>
<div class="paragraph">
<p>The canonical example from LMAX is where we have three operations:
- journalling (writing the input data to a persistent journal file);
- replication (sending the input data to another machine to ensure that there is a remote copy of the data);
- and business logic (the real processing work).</p>
</div>
<div class="paragraph">
<p>Looking at <a href="#user-guide-models">Figure 1</a> is possible to see that there are 3 <code>EventHandler</code>s listening (<code>JournalConsumer</code>, <code>ReplicationConsumer</code> and <code>ApplicationConsumer</code>) to the Disruptor.
Each of these Event Handlers will receive <strong>all</strong> the messages available in the Disruptor (in the same order).
This allows for work for each of these consumers to operate in parallel.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_consumer_dependency_graph">Consumer Dependency Graph</h4>
<div class="paragraph">
<p>To support real world applications of the parallel processing behaviour it was necessary to support co-ordination between the consumers.
Referring back to the example described above, it is necessary to prevent the business logic consumer from making progress until the journalling and replication consumers have completed their tasks.
We call this concept &#8220;gating&#8221; (or, more correctly, the feature is a form of &#8220;gating&#8221;).</p>
</div>
<div class="paragraph">
<p>&#8220;Gating&#8221; happens in two places:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firstly we need to ensure that the producers do not overrun consumers.
This is handled by adding the relevant consumers to the Disruptor by calling <code>RingBuffer.addGatingConsumers()</code>.</p>
</li>
<li>
<p>Secondly, the case referred to previously is implemented by constructing a SequenceBarrier containing Sequences from the components that must complete their processing first.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Referring to <a href="#user-guide-models">Figure 1</a> there are 3 consumers listening for Events from the Ring Buffer.
There is a dependency graph in this example.</p>
</div>
<div class="paragraph">
<p>The ApplicationConsumer depends on the <code>JournalConsumer</code> and <code>ReplicationConsumer</code>.
This means that the <code>JournalConsumer</code> and <code>ReplicationConsumer</code> can run freely in parallel with each other.
The dependency relationship can be seen by the connection from the <code>ApplicationConsumer</code>'s <code>SequenceBarrier</code> to the <code>Sequence</code>s of the <code>JournalConsumer</code> and <code>ReplicationConsumer</code>.</p>
</div>
<div class="paragraph">
<p>It is also worth noting the relationship that the <code>Sequencer</code> has with the downstream consumers.
One of its roles is to ensure that publication does not wrap the Ring Buffer.
To do this none of the downstream consumer may have a <code>Sequence</code> that is lower than the Ring Buffer&#8217;s <code>Sequence</code> less the size of the Ring Buffer.</p>
</div>
<div class="paragraph">
<p>However, by using the graph of dependencies an interesting optimisation can be made.
Because the <code>ApplicationConsumer</code>'s Sequence is guaranteed to be less than or equal to that of the <code>JournalConsumer</code> and <code>ReplicationConsumer</code> (that is what that dependency relationship ensures) the <code>Sequencer</code> need only look at the Sequence of the <code>ApplicationConsumer</code>.
In a more general sense the <code>Sequencer</code> only needs to be aware of the <code>Sequence</code>s of the consumers that are the leaf nodes in the dependency tree.</p>
</div>
</div>
<div class="sect3">
<h4 id="_event_pre_allocation">Event Pre-allocation</h4>
<div class="paragraph">
<p>One of the goals of the Disruptor is to enable use within a low latency environment.
Within low-latency systems it is necessary to reduce or remove memory allocations.
In Java-based system the purpose is to reduce the number stalls due to garbage collection <sup class="footnote" id="_footnote_low-latency">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>To support this the user is able to preallocate the storage required for the events within the Disruptor.
During construction and <code>EventFactory</code> is supplied by the user and will be called for each entry in the Disruptor&#8217;s Ring Buffer.
When publishing new data to the Disruptor the API will allow the user to get hold of the constructed object so that they can call methods or update fields on that store object.
The Disruptor provides guarantees that these operations will be concurrency-safe as long as they are implemented correctly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_optionally_lock_free">Optionally Lock-free</h4>
<div class="paragraph">
<p>Another key implementation detail pushed by the desire for low-latency is the extensive use of lock-free algorithms to implement the Disruptor.
All memory visibility and correctness guarantees are implemented using memory barriers and/or compare-and-swap operations.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is only one use-case where an actual lock is required and that is within the <code>BlockingWaitStrategy</code>.</p>
</div>
<div class="paragraph">
<p>This is done solely for the purpose of using a <strong>condition</strong> so that a consuming thread can be parked while waiting for new events to arrive.
Many low-latency systems will use a busy-wait to avoid the jitter that can be incurred by using a <strong>condition</strong>; however, in number of system busy-wait operations can lead to significant degradation in performance, especially where the CPU resources are heavily constrained, e.g. web servers in virtualised-environments.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started">Getting Started</h3>
<div class="sect3">
<h4 id="_getting_the_disruptor">Getting the Disruptor</h4>
<div class="paragraph">
<p>The Disruptor jar file is available from <a href="https://search.maven.org/artifact/com.lmax/disruptor">Maven Central</a> and can be integrated into your dependency manager of choice from there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_produce_and_consume">Basic Produce and Consume</h4>
<div class="paragraph">
<p>To get started with the Disruptor we are going to consider very simple and contrived example.
We will pass a single <code>long</code> value from a producer to a consumer, and the consumer will simply print out the value.</p>
</div>
<div class="paragraph">
<p>There are currently several styles of writing publishers and consumers for the Disruptor.
Whilst they are all fundamentally similar, there may be slight nuances in each approach that will be covered below.</p>
</div>
<div class="paragraph">
<p>Firstly we will define the <code>Event</code> that will carry the data and is common to all following examples:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>LongEvent</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEvent</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">set</span><span class="tok-p">(</span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-nf">toString</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-s">&quot;LongEvent{&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;value=&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-sc">&#39;}&#39;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to allow the Disruptor to preallocate these events for us, we need to an <code>EventFactory</code> that will perform the construction.
This could be a method reference, such as <code>LongEvent::new</code> or an explicit implementation of the <code>EventFactory</code> interface:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>LongEventFactory</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventFactory</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">EventFactory</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-nf">newInstance</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">LongEvent</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have the event defined, we need to create a consumer that will handle these events.
As an example, we will create an <code>EventHandler</code> that will print the value out to the console.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>LongEventHandler</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventHandler</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">EventHandler</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">onEvent</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Event: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we will need a source for these events.
For simplicity, we will assume that the data is coming from some sort of I/O device, e.g. network or file in the form of a <code>ByteBuffer</code>.</p>
</div>
<div class="sect4">
<h5 id="_publishing">Publishing</h5>
<div class="sect5">
<h6 id="publishing-using-lambdas">Using Lambdas</h6>
<div class="paragraph">
<p>Since version 3.0 of the Disruptor it has been possible to use a Lambda-style API to write publishers.
This is the preferred approach, as it encapsulates much of the complexity of the alternatives.</p>
</div>
<div class="listingblock">
<div class="title">Publishing events using lambdas</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.dsl.Disruptor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.RingBuffer</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEvent</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.util.DaemonThreadFactory</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.nio.ByteBuffer</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventMain</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">Exception</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1024</span><span class="tok-p">;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">        </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">                </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-p">::</span><span class="tok-k">new</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">DaemonThreadFactory</span><span class="tok-p">.</span><span class="tok-na">INSTANCE</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">handleEventsWith</span><span class="tok-p">((</span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Event: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">));</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">start</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>


<span class="tok-w">        </span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">getRingBuffer</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">        </span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-p">.</span><span class="tok-na">allocate</span><span class="tok-p">(</span><span class="tok-mi">8</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">putLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">publishEvent</span><span class="tok-p">((</span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">buffer</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">buffer</span><span class="tok-p">.</span><span class="tok-na">getLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)),</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">Thread</span><span class="tok-p">.</span><span class="tok-na">sleep</span><span class="tok-p">(</span><span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the size of the ring buffer, must be power of 2.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Construct the Disruptor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Connect the handler</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the Disruptor, starts all threads running</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the ring buffer from the Disruptor to be used for publishing.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that the lambda used for <code>publishEvent()</code> only refers to the parameters that are passed in.</p>
</div>
<div class="paragraph">
<p>If we were to instead write that code as:</p>
</div>
<div class="listingblock">
<div class="title">Example of a capturing lambda</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-p">.</span><span class="tok-na">allocate</span><span class="tok-p">(</span><span class="tok-mi">8</span><span class="tok-p">);</span>
<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">putLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">publishEvent</span><span class="tok-p">((</span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">getLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)));</span>
<span class="tok-w">    </span><span class="tok-n">Thread</span><span class="tok-p">.</span><span class="tok-na">sleep</span><span class="tok-p">(</span><span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would create a capturing lambda, meaning that it would need to instantiate an object to hold the <code>ByteBuffer bb</code> variable as it passes the lambda through to the <code>publishEvent()</code> call.
This will create additional (unnecessary) garbage, so the call that passes the argument through to the lambda should be preferred if low GC pressure is a requirement.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given that method references can be used instead of anonymous lambdas, it is possible to rewrite the example in this fashion:</p>
</div>
<div class="listingblock">
<div class="title">Example using method references</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.RingBuffer</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.dsl.Disruptor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEvent</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.util.DaemonThreadFactory</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.nio.ByteBuffer</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventMain</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">handleEvent</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">translate</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">buffer</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">buffer</span><span class="tok-p">.</span><span class="tok-na">getLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">));</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">Exception</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1024</span><span class="tok-p">;</span>

<span class="tok-w">        </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">                </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-p">::</span><span class="tok-k">new</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">DaemonThreadFactory</span><span class="tok-p">.</span><span class="tok-na">INSTANCE</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">handleEventsWith</span><span class="tok-p">(</span><span class="tok-n">LongEventMain</span><span class="tok-p">::</span><span class="tok-n">handleEvent</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">start</span><span class="tok-p">();</span>

<span class="tok-w">        </span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">getRingBuffer</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-p">.</span><span class="tok-na">allocate</span><span class="tok-p">(</span><span class="tok-mi">8</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">putLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">publishEvent</span><span class="tok-p">(</span><span class="tok-n">LongEventMain</span><span class="tok-p">::</span><span class="tok-n">translate</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">Thread</span><span class="tok-p">.</span><span class="tok-na">sleep</span><span class="tok-p">(</span><span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_using_translators">Using Translators</h6>
<div class="paragraph">
<p>Prior to version 3.0, the preferred way of publishing messages was via the Event Publisher/Event Translator interfaces:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>LongEventProducer</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.EventTranslatorOneArg</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.RingBuffer</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.nio.ByteBuffer</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventProducer</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">LongEventProducer</span><span class="tok-p">(</span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">ringBuffer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">EventTranslatorOneArg</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">TRANSLATOR</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">        </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">EventTranslatorOneArg</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-o">&gt;</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-nd">@Override</span>
<span class="tok-w">            </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">translateTo</span><span class="tok-p">(</span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">getLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">));</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">};</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">onData</span><span class="tok-p">(</span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">publishEvent</span><span class="tok-p">(</span><span class="tok-n">TRANSLATOR</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach uses number of extra classes (e.g. handler, translator) that are not explicitly required when using lambdas.
The advantage of here is that the translator code can be pulled into a separate class and easily unit tested.</p>
</div>
<div class="paragraph">
<p>The Disruptor provides a number of different interfaces (<code>EventTranslator</code>, <code>EventTranslatorOneArg</code>, <code>EventTranslatorTwoArg</code>, etc.) that can be implemented to provide translators.
This is to allow for the translators to be represented as static classes and lambdas (see <a href="#publishing-using-lambdas">above</a>).
The arguments to the translation method are passed through the call on the Ring Buffer through to the translator.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_publishing_using_the_legacy_api">Publishing Using the Legacy API</h5>
<div class="paragraph">
<p>There is a more "raw" approach that we can use:</p>
</div>
<div class="listingblock">
<div class="title">Example Legacy <code>LongEventProducer</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.RingBuffer</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEvent</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.nio.ByteBuffer</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventProducer</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">LongEventProducer</span><span class="tok-p">(</span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">ringBuffer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">onData</span><span class="tok-p">(</span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">next</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-k">try</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">sequence</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">            </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">getLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">finally</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">ringBuffer</span><span class="tok-p">.</span><span class="tok-na">publish</span><span class="tok-p">(</span><span class="tok-n">sequence</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Grab the next sequence</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the entry in the Disruptor for that sequence</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fill the entry with data</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What becomes immediately obvious is that event publication becomes more involved than using a simple queue.
This is due to the desire for Event pre-allocation.
It requires (at the lowest level) a 2-phase approach to message publication, i.e. claim the slot in the ring buffer and then publish the available data.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is also necessary to wrap publication in a <code>try</code>/<code>finally</code> block.</p>
</div>
<div class="paragraph">
<p>If we claim a slot in the Ring Buffer (calling <code>RingBuffer#next()</code>) then we must publish this sequence.
Failing to do so can result in corruption of the state of the Disruptor.</p>
</div>
<div class="paragraph">
<p>Specifically, in the multi-producer case, this will result in the consumers stalling and being unable to recover without a restart.
Therefore, it is recommended that either the lambda or <code>EventTranslator</code> APIs be used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The final step is to wire the whole thing together.
Whilst it is possible to wire up each component manually, this can be complicated and so a DSL is provided to simplify construction.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some of the more complicated options are not available via the DSL; however, it is suitable for most circumstances.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example using the legacy <code>LongEventProducer</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.RingBuffer</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.dsl.Disruptor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEvent</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEventFactory</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.examples.longevent.LongEventHandler</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.util.DaemonThreadFactory</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.nio.ByteBuffer</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventMain</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">Exception</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">LongEventFactory</span><span class="tok-w"> </span><span class="tok-n">factory</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">LongEventFactory</span><span class="tok-p">();</span>

<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1024</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">                </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">(</span><span class="tok-n">factory</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">bufferSize</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">DaemonThreadFactory</span><span class="tok-p">.</span><span class="tok-na">INSTANCE</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">handleEventsWith</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">LongEventHandler</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">start</span><span class="tok-p">();</span>

<span class="tok-w">        </span><span class="tok-n">RingBuffer</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ringBuffer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-p">.</span><span class="tok-na">getRingBuffer</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">LongEventProducer</span><span class="tok-w"> </span><span class="tok-n">producer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">LongEventProducer</span><span class="tok-p">(</span><span class="tok-n">ringBuffer</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">ByteBuffer</span><span class="tok-w"> </span><span class="tok-n">bb</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ByteBuffer</span><span class="tok-p">.</span><span class="tok-na">allocate</span><span class="tok-p">(</span><span class="tok-mi">8</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">bb</span><span class="tok-p">.</span><span class="tok-na">putLong</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">l</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">producer</span><span class="tok-p">.</span><span class="tok-na">onData</span><span class="tok-p">(</span><span class="tok-n">bb</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">Thread</span><span class="tok-p">.</span><span class="tok-na">sleep</span><span class="tok-p">(</span><span class="tok-mi">1000</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basic_tuning_options">Basic Tuning Options</h4>
<div class="paragraph">
<p>Using the above approach will work functionally in the widest set of deployment scenarios.
However, there are a number of tuning options that can be used to improve performance.</p>
</div>
<div class="paragraph">
<p>The two main options for tuning are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_single_vs_multiple_producers">Single vs. multiple producers</a>, <em>and</em></p>
</li>
<li>
<p><a href="#_alternative_wait_strategies">Alternative wait strategies</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both of these options are set when constructing a Disruptor:</p>
</div>
<div class="listingblock">
<div class="title">Tuning the Disruptor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">LongEventMain</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">//.....</span>
<span class="tok-w">        </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Disruptor</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">factory</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">bufferSize</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">DaemonThreadFactory</span><span class="tok-p">.</span><span class="tok-na">INSTANCE</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">ProducerType</span><span class="tok-p">.</span><span class="tok-na">SINGLE</span><span class="tok-p">,</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">            </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">BlockingWaitStrategy</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-c1">//.....</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>ProducerType#SINGLE</code> to create a <code>SingleProducerSequencer</code>; use <code>ProducerType#MULTI</code> to create a <code>MultiProducerSequence</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the desired <code>WaitStrategy</code></td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_single_vs_multiple_producers">Single vs. Multiple Producers</h5>
<div class="paragraph">
<p>One of the best ways to improve performance in concurrent systems is to adhere to the <a href="https://mechanical-sympathy.blogspot.com/2011/09/single-writer-principle.html">Single Writer Principle</a>, this applies to the Disruptor.
If you are in the situation where there will only ever be a single thread producing events into the Disruptor, then you can take advantage of this to gain additional performance.</p>
</div>
<div class="paragraph">
<p>To give an indication of how much of a performance advantage can be achieved through this technique we can change the producer type in the OneToOne performance test.
Tests run on i7 Sandy Bridge MacBook Air.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 1. Multiple Producer</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=26,553,372 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=28,727,377 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=29,806,259 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=29,717,682 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=28,818,443 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=29,103,608 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=29,239,766 ops/sec</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 2. Single Producer</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=89,365,504 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=77,579,519 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=78,678,206 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=80,840,743 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=81,037,277 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=81,168,831 ops/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run 6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disruptor=81,699,346 ops/sec</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_alternative_wait_strategies">Alternative Wait Strategies</h5>
<div class="paragraph">
<p>The default <code>WaitStrategy</code> used by the Disruptor is the <code>BlockingWaitStrategy</code>.
Internally the <code>BlockingWaitStrategy</code> uses a typical lock and condition variable to handle thread wake-up.
The <code>BlockingWaitStrategy</code> is the slowest of the available wait strategies, but is the most conservative with the respect to CPU usage and will give the most consistent behaviour across the widest variety of deployment options.</p>
</div>
<div class="paragraph">
<p>Knowledge of the deployed system can allow for additional performance by choosing a more appropriate wait strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>SleepingWaitStrategy</strong> &#8594;</p>
</li>
</ul>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Like the <code>BlockingWaitStrategy</code> the <code>SleepingWaitStrategy</code> it attempts to be conservative with CPU usage by using a simple busy wait loop.
The difference is that the <code>SleepingWaitStrategy</code> uses a call to <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/locks/LockSupport.html#parkNanos(long)" target="_blank" rel="noopener"><code>LockSupport.parkNanos(1)</code></a> in the middle of the loop.
On a typical Linux system this will pause the thread for around 60s.</p>
</div>
<div class="paragraph">
<p>This has the benefits that the producing thread does not need to take any action other increment the appropriate counter and that it does not require the cost of signalling a condition variable.
However, the mean latency of moving the event between the producer and consumer threads will be higher.</p>
</div>
<div class="paragraph">
<p>It works best in situations where low latency is not required, but a low impact on the producing thread is desired.
A common use case is for asynchronous logging.</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>YieldingWaitStrategy</strong> &#8594;</p>
</li>
</ul>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The <code>YieldingWaitStrategy</code> is one of two <code>WaitStrategy</code>s that can be use in low-latency systems.
It is designed for cases where there is the option to burn CPU cycles with the goal of improving latency.</p>
</div>
<div class="paragraph">
<p>The <code>YieldingWaitStrategy</code> will busy spin, waiting for the sequence to increment to the appropriate value.
Inside the body of the loop <code>Thread#yield()</code> will be called allowing other queued threads to run.</p>
</div>
<div class="paragraph">
<p>This is the recommended wait strategy when you need very high performance, and the number of <code>EventHandler</code> threads is lower than the total number of logical cores, e.g. you have hyper-threading enabled.</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>BusySpinWaitStrategy</strong> &#8594;</p>
</li>
</ul>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The <code>BusySpinWaitStrategy</code> is the highest performing <code>WaitStrategy</code>.
Like the <code>YieldingWaitStrategy</code>, it can be used in low-latency systems, but puts the highest constraints on the deployment environment.</p>
</div>
<div class="paragraph">
<p>This wait strategy should only be used if the number of <code>EventHandler</code> threads is lower than the number of physical cores on the box, e.g. hyper-threading should be disabled.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clearing_objects_from_the_ring_buffer">Clearing Objects From the Ring Buffer</h4>
<div class="paragraph">
<p>When passing data via the Disruptor, it is possible for objects to live longer than intended.
To avoid this happening it may be necessary to clear out the event after processing it.</p>
</div>
<div class="paragraph">
<p>If you have a single event handler, clearing out the value within the same handler is sufficient.
If you have a chain of event handlers, then you may need a specific handler placed at the end of the chain to handle clearing out the object.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>ObjectEvent</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">class</span> <span class="tok-nc">ObjectEvent</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">T</span><span class="tok-w"> </span><span class="tok-n">val</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">clear</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">val</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>ClearingEventHandler</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.lmax.disruptor.EventHandler</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ClearingEventHandler</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">EventHandler</span><span class="tok-o">&lt;</span><span class="tok-n">ObjectEvent</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">onEvent</span><span class="tok-p">(</span><span class="tok-n">ObjectEvent</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-na">clear</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Failing to call <code>clear()</code> here will result in the object associated with the event to live until it is overwritten.
This will only happen once the ring buffer has wrapped around to the beginning.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example using the <code>ClearingEventHandler</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;</span><span class="tok-n">ObjectEvent</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-n">disruptor</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Disruptor</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ObjectEvent</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">BUFFER_SIZE</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">DaemonThreadFactory</span><span class="tok-p">.</span><span class="tok-na">INSTANCE</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-n">disruptor</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">handleEventsWith</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ProcessingEventHandler</span><span class="tok-p">())</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">then</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ClearingEventHandler</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_techniques">Advanced Techniques</h3>
<div class="sect3">
<h4 id="_dealing_with_large_batches">Dealing With Large Batches</h4>
<div class="listingblock">
<div class="title">Example of "Early Release"</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">EarlyReleaseHandler</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">EventHandler</span><span class="tok-o">&lt;</span><span class="tok-n">LongEvent</span><span class="tok-o">&gt;</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Sequence</span><span class="tok-w"> </span><span class="tok-n">sequenceCallback</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">batchRemaining</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">20</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">setSequenceCallback</span><span class="tok-p">(</span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">Sequence</span><span class="tok-w"> </span><span class="tok-n">sequenceCallback</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">sequenceCallback</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">sequenceCallback</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">onEvent</span><span class="tok-p">(</span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sequence</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">processEvent</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-n">logicalChunkOfWorkComplete</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">isLogicalChunkOfWorkComplete</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">logicalChunkOfWorkComplete</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">sequenceCallback</span><span class="tok-p">.</span><span class="tok-na">set</span><span class="tok-p">(</span><span class="tok-n">sequence</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-n">batchRemaining</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">logicalChunkOfWorkComplete</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">endOfBatch</span><span class="tok-w"> </span><span class="tok-o">?</span><span class="tok-w"> </span><span class="tok-mi">20</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">batchRemaining</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-nf">isLogicalChunkOfWorkComplete</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// Ret true or false based on whatever criteria is required for the smaller</span>
<span class="tok-w">        </span><span class="tok-c1">// chunk.  If this is doing I/O, it may be after flushing/syncing to disk</span>
<span class="tok-w">        </span><span class="tok-c1">// or at the end of DB batch+commit.</span>
<span class="tok-w">        </span><span class="tok-c1">// Or it could simply be working off a smaller batch size.</span>

<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-o">--</span><span class="tok-n">batchRemaining</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">processEvent</span><span class="tok-p">(</span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">LongEvent</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// Do processing</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_and_implementation">Design and Implementation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Single Producer Algorithm</p>
</li>
<li>
<p>Multiple Producer Algorithm</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_known_issues">Known Issues</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>On 32 bit Linux systems it appears that <code>LockSupport.parkNanos()</code> is quite expensive, therefore using the <code>SleepingWaitStrategy</code> is not recommended.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_batch_rewind">Batch Rewind</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_feature">The Feature</h3>
<div class="paragraph">
<p>When using the <code>BatchEventProcessor</code> to handle events as batches, there is a feature available that can be used to recover from an exception named "Batch Rewind".</p>
</div>
<div class="paragraph">
<p>If something goes wrong while handling an event that is recoverable, the user can throw a <code>RewindableException</code>. This will invoke the <code>BatchRewindStrategy</code> instead of the usual <code>ExceptionHandler</code> to decide whether the sequence number should rewind back to the beginning of the batch to be reattempted or rethrow and delegate to the <code>ExceptionHandler</code>.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="paragraph">
<p>When using the <code>SimpleBatchRewindStrategy</code> (which will always rewind) then the <code>BatchEventProcessor</code> receives a batch from 150 &#8594; 155, but a temporary failure happens on sequence 153 (which throws a <code>RewindableException</code>). The events processed will look like the following&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>150, 151, 152, 153(failed -&gt; rewind), 150, 151, 152, 153(succeeded this time), 154, 155</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default <code>BatchRewindStrategy</code> is the <code>SimpleBatchRewindStrategy</code> but different strategies can be provided to the <code>BatchEventProcessor</code> like so&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>        batchEventProcessor.setRewindStrategy(batchRewindStrategy);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_use_case">Use Case</h3>
<div class="paragraph">
<p>This can be very useful when batches are handled as database transactions. So the start of a batch starts a transaction, events are handled as statements, and only committed at the end of a batch.</p>
</div>
<div class="paragraph">
<p>Happy case</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Batch start -&gt; START TRANSACTION;
Event 1 -&gt;     insert a row;
Event 2 -&gt;     insert a row;
Event 3 -&gt;     insert a row;
Batch end -&gt;   COMMIT;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sad case without Batch Rewind</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Batch start -&gt; START TRANSACTION;
Event 1 -&gt;     insert a row;
Event 2 -&gt;     DATABASE has a blip and can not commit
Throw error -&gt; ROLLBACK;
User needs to explcitily reattempt the batch or choose to abandon the batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sad case with Batch Rewind</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Batch start -&gt;               START TRANSACTION;
Event 1 -&gt;                   insert a row;
Event 2 -&gt;                   DATABASE has a blip and can not insert
Throw RewindableException -&gt; ROLLBACK;
Batch start -&gt;               START TRANSACTION;
Event 1 -&gt;                   insert a row;
Event 2 -&gt;                   insert a row;
Event 3 -&gt;                   insert a row;
Batch end -&gt;                 COMMIT;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. in low-latency C/C++ systems,heavy memory allocation is also problematic due to the contention that be placed on the memory allocator
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 4.0.0-SNAPSHOT<br>
Last updated 2023-09-07 15:13:51 UTC
</div>
</div>
</body>
</html>